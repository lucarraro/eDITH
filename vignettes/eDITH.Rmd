---
title: "An introduction to eDITH"
author: "Luca Carraro"
output: 
    bookdown::html_document2: #rmarkdown::html_vignette: # pdf_document 
      base_format: rmarkdown::html_vignette
      toc: true
      number_sections: true
      fig_caption: true
vignette: >
  %\VignetteIndexEntry{An introduction to eDITH}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
``` 

```{r lib, echo = FALSE}
suppressPackageStartupMessages(library(eDITH))
```


# Overview

`eDITH` (**eD**NA **I**ntegrating **T**ransport and **H**ydrology) allows interpreting environmental DNA data collected from river networks. It implements the eDITH model, which couples a geomorphological and hydrological characterization of a catchment, eDNA transport and decay dynamics, and a species distribution model, and allows transforming pointwise eDNA
data collected at a catchment into predicted maps of taxon density. 

Features:

* It provides estimations of detection probability of a taxon across a whole catchment based on spatially replicated eDNA data 
* It can handle both eDNA concentration data (e.g., from qPCR) and metabarcoding (read counts) data
* Model fit can be performed via Bayesian techniques or optimization algorithms 
* Covariates can be specified by the user and/or selected by means of Asymmetric Eigenvector Maps (AEMs)
* An interface to the `DHARMa` package for residual diagnostics is provided

`eDITH` requires the use of river networks defined as `river` objects, which can be built via the `rivnet` package.

# Installing the package

The development version of `eDITH` can be installed from Github:

```{r, eval=FALSE}
devtools::install_github("lucarraro/eDITH")
```

Among other packages, `eDITH` depends on `rivnet`, which in turn depends on the `traudem` package. `traudem` relies on the [TauDEM](https://hydrology.usu.edu/taudem/taudem5/) library. `traudem` provides a guide to correct installation of TauDEM and its dependencies for different operating systems, and offers wrapper commands to call TauDEM methods from R. Please read the `traudem` [documentation](https://lucarraro.github.io/traudem/) carefully.

# The eDITH model in a nutshell

# Required data

# Specifying covariates

```{r overview, echo=FALSE, fig.cap="Flowchart for the choice of covariates used to fit the eDITH model in `run_eDITH_BT` and `run_eDITH_optim`.", out.width = '90%'}
knitr::include_graphics("flowchart_cov.png")

```

# Likelihood function and model parameters

By default, `eDITH` implements four probability distributions to model errors between observed and modelled data: 

* the normal (`ll.type = "norm"`) and log-normal (`ll.type = "lnorm"`) distributions are suitable to model *eDNA concentration* data. 
* the geometric (`ll.type = "geom"`) and negative binomial (`ll.type = "nbinom"`) distributions are suitable for *read count* data. 

**Note that the user is expected to set option `ll.type` according to the nature of the `data` provided in `run_eDITH_BT` or `run_eDITH_optim`.** 

Moreover, the optional argument `no.det = TRUE` can be used to produce a zero-inflated error distribution. This is mandatory if `ll.type = "lnorm"`, as the log-normal distribution does not admit zeros.

Default model parameters are as follows:

* `tau` represents decay time $\tau$ in hours.
* `log_p0` is the logarithm in base 10 of the baseline production rate $p_0$. The units of $p_0$ are equal to the units of the inputted `data$values` multiplied by a length unit and divided by a time unit. For instance, if `data$values` contains eDNA concentration data in mol m^-3^ and the river object contains discharge (`river$AG$Q`) in m^3^s^-1^ and areas^[This depends on the resolution of the DEM used to obtain the river network in `rivnet::extract_river`] in m^2^, $p_0$ is expressed in mol m^-2^ s^-1^ (i.e. amount of eDNA shed per unit area and unit time). In the case of read count data, the unit for $p_0$ might look weird; this is because, in this case, $p_0$ embeds a constant that transforms expected eDNA concentration predicted by the model into expected read number.
* `beta_X` is the effect size of covariate `X`, where `X` is replaced by the object names in the `covariates` data frame (if provided), and/or by e.g. `AEM1` when AEM eigenfunctions are used. In this case, the number indicates the corresponding eigenfunction.

Additional parameters can be added depending on the likelihood definition:

* `sigma` is the standard deviation of the error (when `ll.type = "norm"` or "lnorm"). Note that, if a log-normal distribution is used, `sigma` is the standard deviation of the non-log-transformed values (and is hence different than parameter `sdlog` of `dlnorm`).
* `omega` is the overdispersion parameter (when `ll.type = "nbinom"`), which is defined as the ratio between variance and mean [@linden2011].
* no additional error parameter is present if `ll.type = "geom"`.
* `Cstar` is a further parameter added when the optional argument `no.det = TRUE` is passed. In this case, the probability of non-detection is expressed as `exp(-C/Cstar)`, where `C` is the modelled eDNA value (expected concentration or read number) at a given site. Increased `Cstar` increases the non-detection probability, all else being equal. See @carraro2018 for details. 



# A minimal example


# References

---
references:

- id: carraro2018
  title: Estimating species distribution and abundance in river networks using environmental DNA
  author:
  - family: Carraro
    given: L.
  - family: Hartikainen
    given: H.
  - family: Jokela
    given: J.
  - family: Bertuzzo
    given: E.
  - family: Rinaldo
    given: A.
  container-title: Proceedings of the National Academy of Sciences of the United States of America
  URL: 'https://doi.org/10.1073/pnas.1813843115'
  type: article-journal
  issued:
    year: 2018


- id: linden2011
  title: Using the negative binomial distribution to model overdispersion in ecological count data
  author:
  - family: Lindén
    given: A.
  - family: Mäntyniemi
    given: S.
  container-title: Ecology
  URL: 'https://doi.org/10.1890/10-1831.1'
  type: article-journal
  issued:
    year: 2011
    
    
---    

